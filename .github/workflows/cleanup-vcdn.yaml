name: VCDN Folder File Count

on:
  workflow_dispatch:
    inputs:
      folder_name:
        description: "VCDN folder name (leave empty to list folders only)"
        required: false

jobs:
  vcdn-check:
    runs-on: ubuntu-latest
    timeout-minutes: 120

    steps:
      - name: Install sshpass
        run: |
          sudo apt-get update
          sudo apt-get install -y sshpass

      - name: List VCDN folders or count files
        env:
          VM_IP: 172.20.10.7
          VM_USER: root
          VM_PASS: ${{ secrets.VM_ROOT_PASSWORD }}
          FOLDER: ${{ github.event.inputs.folder_name }}
        run: |
          SSH="ssh $VM_USER@$VM_IP"

          if [ -z "$FOLDER" ]; then
            echo "üìÇ Available VCDN folders:"
            $SSH "ls -d /otss/data/vcdn/*/ | xargs -n 1 basename"
            echo ""
            echo "‚û° Re-run workflow and provide folder_name to count files"
            exit 0
          fi

          echo "üîç Counting files in: /otss/data/vcdn/$FOLDER"
          $SSH "
            if [ ! -d /otss/data/vcdn/$FOLDER ]; then
              echo '‚ùå Folder does not exist'
              exit 1
            fi

            find /otss/data/vcdn/$FOLDER -type f | wc -l
          "
